# Modifications to the 10-Week and 12-Week Transfer Analysis (Per Golden Database Investigation)

## 12-Week Pipeline (Production)

The **12-week pipeline** uses dynamic Mon–Sun week generation instead of hardcoded `WEEK_RANGES`:

1. Run `run_update_precios_unit_prices.sh` to ensure PRECIOS.xlsx has PRECIO UNITARIO (UNIDAD logic).
2. Run `run_weekly_transfers.sh`, which passes `--weeks 12` and `--exclude-cedis-dest` to the Python script.
3. Run `run_weekly_transfer_pivots.sh` to build pivot marts.

The script accepts `--weeks N` (e.g. `--weeks 12`) to generate the last N Mon–Sun weeks from `--end` (or today). Use `--end YYYY-MM-DD` to anchor the last week (e.g. last Sunday).

### UNIDAD Semantics (PRECIOS.xlsx)

PRECIOS.xlsx uses the UNIDAD column to determine unit price:

| UNIDAD | Meaning | PRECIO UNITARIO |
|--------|---------|-----------------|
| LT, KG | PRECIO DRIVE is already the unit price | Use PRECIO DRIVE as-is |
| PZ | PRECIO DRIVE is the presentation price | PRECIO UNITARIO = PRECIO DRIVE / PRESENTACION |

`update_precios_with_unit_prices.py` writes the PRECIO UNITARIO column. `load_precios()` prefers PRECIO UNITARIO when present.

---

## Implementation Status (10-Week / 12-Week)

| Section | Status |
|---------|--------|
| 1. Price Sources by Origin (AG/PT split) | Done |
| 2. PRECIOS and AG_PRECIOS Content | Done (run compare_unit_prices_full, investigate_transfer_cost) |
| 3. Transfers to CEDIS | Done (`--exclude-cedis-dest` default; `--include-cedis-dest` opt-in) |
| 4. Producto Matching | Done (PRODUCTO_ALIASES, asterisk normalization) |
| 5. Date Range | Done (`--last-week-feb-8` option) |
| 6. Expected Totals | Done (Gold_Reference, Gold_NUMEROS in weekly_breakdown.csv) |
| 7. Summary Checklist | Done |
| 8. Script Invocation | Done |

---

## Overview

The **10-week analysis** runs `get_weekly_transfers_with_prices.py` for 10 weekly periods (Mon–Sun) from Dec 1, 2025 to Feb 7, 2026. It fetches transfer data, applies unit prices from PRECIOS.xlsx and AG_PRECIOS.xlsx, and produces consolidated CSVs plus cost-difference reports.

This document describes how to correct the analysis based on findings from the golden reference investigation (`TRANSFERENCIAS DEL 02 AL 08 FEBRERO.xlsx`).

---

## 1. Price Sources by Origin

### Finding

The golden file uses different price sources by origin:

- **ALMACEN GENERAL (AG)**: prices come from `*-AG` sheets (e.g. KAVIA-AG, PV-AG) and only rows where `Almacén origen = ALMACEN GENERAL`.
- **ALMACEN PRODUCTO TERMINADO (PT)**: prices come from `*-PT-R` sheets (e.g. KAVIA-PT-R, HZ-PT-R) and only rows where `Almacén origen = ALMACEN PRODUCTO TERMINADO`.

`*-PT-W` sheets and PT rows in AG sheets are **not** correct; they use old or wrong unit costs.

### Modification

**Already implemented.** `apply_prices()` in `get_weekly_transfers_with_prices.py`:

- Uses **AG_PRECIOS.xlsx** only for rows where `Almacén origen = ALMACEN GENERAL`.
- Uses **PRECIOS.xlsx** only for rows where `Almacén origen = ALMACEN PRODUCTO TERMINADO`.

Ensure both files are loaded and applied as above:

```python
# In apply_prices():
# PT rows: use PRECIOS
# AG rows: use AG_PRECIOS (if available)
```

---

## 2. PRECIOS and AG_PRECIOS Content

### Finding

PRECIOS and AG_PRECIOS must be aligned with the golden data:

- **AG_PRECIOS**: product list and unit prices from `*-AG` sheets (ALMACEN GENERAL rows only). Generated by `investigate_transfer_cost.py` (131 products).
- **PRECIOS**: PT product prices aligned with `*-PT-R` sheets, with unreasonable gold values excluded (e.g. CHEESECAKE TORTUGA 0.005, Tocino sub 95 vs 380).

### Modification

1. **Regenerate AG_PRECIOS** when the golden file changes:
   ```bash
   python testing/investigate_transfer_cost.py
   ```
   This overwrites `AG_PRECIOS.xlsx` from the golden AG sheets.

2. **Regenerate PRECIOS** when the golden file changes:
   ```bash
   python testing/compare_unit_prices_full.py
   ```
   Then copy `PRECIOS_UPDATED.xlsx` to `PRECIOS.xlsx` (or point `--precios-path` at the updated file).

3. **Before running the 10-week analysis**, ensure PRECIOS and AG_PRECIOS are up to date:
   ```bash
   python testing/compare_unit_prices_full.py
   # Review unit_price_investigation_report.md
   # If needed: Copy PRECIOS_UPDATED.xlsx → PRECIOS.xlsx, AG_PRECIOS_UPDATED.xlsx → AG_PRECIOS.xlsx
   ```

---

## 3. Transfers to CEDIS

### Finding

Gold NUMEROS and detail sheets only include transfers **to branches**, not **to CEDIS**. The 58 unmatched rows (~71k) are all transfers to CEDIS, which gold does not track.

### Modification

**Already implemented.** The script supports `--exclude-cedis-dest` to exclude CEDIS from totals. Use it when comparing to gold or mart outputs:

```bash
python testing/get_weekly_transfers_with_prices.py --exclude-cedis-dest
```

`weekly_cost_comparison.csv` and `weekly_breakdown.csv` should be produced with and without CEDIS for clarity. Document that gold-comparable totals exclude CEDIS.

---

## 4. Producto Matching

### Finding

Unmatched products keep Wansoft prices. Causes include:

- Typos (e.g. `Mayonesa de Panem` vs `Mayones de Panem`)
- Spacing (e.g. `CEBOLLA ENCURTIDA*` vs `CEBOLLA ENCURTIDA *`)
- Encoding differences

### Modification

1. **Add alias mappings** in PRECIOS or AG_PRECIOS for known typos/variants:
   - `Mayones de Panem *` → `Mayonesa de Panem *`
   - `Sopa de tomate *` vs `Sopa de tomate*` (with/without space before asterisk)

2. **Normalize product names** before matching (already done via `normalize_producto_for_match` with strip + lowercase).

3. **Review unmatched products** before each run:
   ```bash
   python testing/compare_unit_prices_full.py
   # Review transfer_products_not_in_precios.csv
   ```
   Add missing products to PRECIOS or AG_PRECIOS from gold when possible.

---

## 5. Date Range

### Finding

Golden file date range: Feb 2–8. Current last week: Feb 2–7. Missing Feb 8 can explain small differences.

### Modification

1. **Optionally extend the last week** to Feb 2–8 if gold uses that range:
   ```python
   # In WEEK_RANGES, change last week:
   (date(2026, 2, 2), date(2026, 2, 8)),  # was Feb 2-7
   ```
   Note: requires core.fetch to support Feb 8 for raw data.

2. **Document** that gold uses Feb 2–8 for the last week; if our analysis stays Feb 2–7, totals will be slightly lower.

---

## 6. Expected Totals and Reconciliation

### Finding

- Gold NUMEROS total: 283,368 (for Feb 2–8, branches only).
- Gold detail sheets (AG + PT-R by origin): ~311,794 for Feb 2–7.
- Our totals: ~315k to branches for Feb 2–7.
- NUMEROS is not the sum of the detail sheets; it likely uses a different aggregation.

### Modification

1. **Reconciliation expectations**:
   - Use gold detail (AG + PT-R) as the reference: ~312k for Feb 2–7.
   - Our ~315k is ~2–3k over. Remaining gap comes from:
     - Extra rows we have (14 branch rows gold doesn't),
     - ~34 transfer products not in PRECIOS/AG_PRECIOS (Wansoft prices).

2. **Output**:
   - In `weekly_breakdown.csv`, add columns or notes:
     - `Gold_Reference`: ~312k for Feb 2–7 (gold detail).
     - `Gold_NUMEROS`: 283k (different aggregation; not directly comparable).

3. **Do not** assume our totals can reach 283k by price changes alone; NUMEROS uses a different process.

---

## 7. Summary Checklist

Before running the 10-week analysis, ensure:

| Step | Action |
|------|--------|
| 1 | Run `python testing/compare_unit_prices_full.py` to refresh PRECIOS and AG_PRECIOS from gold and review unit_price_investigation_report.md |
| 2 | Use PRECIOS.xlsx and AG_PRECIOS.xlsx produced by the investigation (or copy from _UPDATED) |
| 3 | Use `--exclude-cedis-dest` when comparing to gold or mart outputs |
| 4 | Review `transfer_products_not_in_precios.csv` and add missing products if gold has them |
| 5 | Add Producto alias mappings for known typos (Mayonesa, Sopa de tomate, etc.) |
| 6 | Document expected totals: gold detail ~312k (Feb 2–7), NUMEROS 283k (different aggregation) |

---

## 8. Script Invocation

**12-week production (recommended):**

```bash
# Via shell (runs run_update_precios_unit_prices.sh first)
./scripts/mac-code-kit/run_weekly_transfers.sh

# Or directly:
python testing/get_weekly_transfers_with_prices.py \
  --data-root data \
  --precios-path PRECIOS.xlsx \
  --ag-precios-path AG_PRECIOS.xlsx \
  --weeks 12 \
  --end 2026-02-08 \
  --exclude-cedis-dest
```

**Legacy 10-week (hardcoded WEEK_RANGES):**

```bash
python testing/get_weekly_transfers_with_prices.py \
  --data-root data \
  --precios-path PRECIOS.xlsx \
  --ag-precios-path AG_PRECIOS.xlsx \
  --start 2025-12-01 \
  --end 2026-02-07 \
  --exclude-cedis-dest
```

Both:

- Load PRECIOS and AG_PRECIOS with gold-aligned prices.
- Apply AG_PRECIOS to AG rows and PRECIOS to PT rows.
- Exclude CEDIS from totals for gold/mart comparison.
- Produce `weekly_breakdown.csv`, `weekly_cost_comparison.csv`, and `price_correction_report.csv`.

---

## 9. Related Files

| File | Purpose |
|------|---------|
| `testing/get_weekly_transfers_with_prices.py` | 10-week analysis script |
| `testing/investigate_transfer_cost.py` | Parses gold, builds AG_PRECIOS |
| `testing/compare_unit_prices_full.py` | Full PRECIOS vs gold comparison, outputs updated PRECIOS |
| [investigation_report.md](investigation_report.md) | High-level investigation summary |
| `data/c_processed/transfers/weekly/edge_case_investigation.md` | Edge cases and NUMEROS vs detail |
| `data/c_processed/transfers/weekly/unit_price_investigation_report.md` | Unit price comparison report |
